import{_ as i,c as a,a as e,o as n}from"./app-CS9K37Kg.js";const t={};function p(o,s){return n(),a("div",null,s[0]||(s[0]=[e(`<h2 id="介绍" tabindex="-1"><a class="header-anchor" href="#介绍"><span>介绍</span></a></h2><p>在<code>ReactNative</code>中使用了<code>@rnmapbox/maps</code>来集成<code>Mapbox</code>地图，开发应用时，在使用<code>Xcode</code>编译代码时，<code>MapboxMaps</code>包里面有一个报错：<code>Cannot convert return expression of type &#39;[UIView : ViewAnnotationOptions]&#39; to return type &#39;Dictionary&lt;String, Optional&lt;JSONValue&gt;&gt;.RawValue&#39; (aka &#39;Dictionary&lt;String, Optional&lt;Any&gt;&gt;&#39;)</code>，记录一下处理方案。</p><h2 id="版本信息" tabindex="-1"><a class="header-anchor" href="#版本信息"><span>版本信息</span></a></h2><ul><li><code>Dev OS</code>：<code>OSX 15.1.1</code></li><li><code>Xcode</code>: <code>16.2</code></li><li><code>Expo version</code>：<code>52.0.7</code></li><li><code>ReactNative</code>：<code>0.76.3</code></li><li><code>@rnmapbox/maps</code>：<code>10.1.33</code></li><li><code>mapbox-gl</code>：<code>@rnmapbox/maps 10.1.33</code>对应版本对应的版本<code>^2.9.0</code>。</li></ul><p><strong>注意</strong> 目前（<code>2025-1-13</code>）最新的<a href="https://www.npmjs.com/package/mapbox-gl" target="_blank" rel="noopener noreferrer">mapbox-gl</a>版本为<code>v3.9.2</code>。</p><h2 id="问题" tabindex="-1"><a class="header-anchor" href="#问题"><span>问题</span></a></h2><p>在<code>Xcode</code>中编译代码时，<code>MapboxMaps</code>包里面有一个报错。报错位置为：<code>Pods</code>-&gt;<code>Pods</code>-&gt;<code>MapboxMaps</code>-&gt;<code>ViewAnnotationManager</code>。</p><p>报错的<code>76-82</code>行如下：</p><div class="language-swift line-numbers-mode" data-ext="swift" data-title="swift"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">/// The complete list of annotations associated with the receiver.</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">@</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">available</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">*</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">deprecated</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">message</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Use ViewAnnotation</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">public</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> var</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> annotations: </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">UIView</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> ViewAnnotationOptions</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    idsByView.</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">compactMapValues</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> [mapboxMap] id </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">in</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">        try</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">?</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> mapboxMap.</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">options</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">forViewAnnotationWithId</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> id</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在<code>idsByView.compactMapValues { [mapboxMap] id in</code>这行代码这里提示：</p><div class="language-sh line-numbers-mode" data-ext="sh" data-title="sh"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">not</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> convert</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> return</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> expression</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> of</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> type</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">[UIView : ViewAnnotationOptions]</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> to</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> return</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> type</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Dictionary&lt;String, Optional&lt;JSONValue&gt;&gt;.RawValue</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> (aka </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Dictionary&lt;String, Optional&lt;Any&gt;&gt;</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="分析" tabindex="-1"><a class="header-anchor" href="#分析"><span>分析</span></a></h2><p>通过<code>annotations</code>属性的源代码，可以看出，该代码已经被标记为<code>@available(*, deprecated, message: &quot;Use ViewAnnotation&quot;)</code>，表示这个属性已经过时，建议使用<code>ViewAnnotation</code>。我们本身应该没有使用这个属性，但是<code>MapboxMaps</code>包里面有一个<code>ViewAnnotationManager</code>类，这个类里面使用了这个属性，导致编译错误。</p><p>看报错内容，可以知道这是一个类型错误，<code>[UIView : ViewAnnotationOptions]</code>不能转换为<code>Dictionary&lt;String, Optional&lt;JSONValue&gt;&gt;.RawValue</code>，即<code>Dictionary&lt;String, Optional&lt;Any&gt;&gt;</code>。</p><p>既然只是一个类型转换错误，我们又没有使用，那么我们可以忽略掉这个转换。</p><h2 id="解决方案" tabindex="-1"><a class="header-anchor" href="#解决方案"><span>解决方案</span></a></h2><p>这里我们之间返回一个空字典即可，修改<code>ViewAnnotationManager</code>的<code>annotations</code>属性，如下：</p><div class="language-swift line-numbers-mode" data-ext="swift" data-title="swift"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">/// The complete list of annotations associated with the receiver.</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">@</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">available</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">*</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">deprecated</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">message</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Use ViewAnnotation</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">public</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> var</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> annotations: </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">UIView</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> ViewAnnotationOptions</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    return</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> [</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">:</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>修改完成之后，再次编译，则通过了编译了。运行我们的应用，没有问题。</p><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结"><span>总结</span></a></h2><p>上面的问题我已经在<code>rnmapbox/maps</code>中提交了一个<code>issue</code>。<a href="https://github.com/rnmapbox/maps/issues/3738" target="_blank" rel="noopener noreferrer">not convert return expression of type &#39;[UIView : ViewAnnotationOptions]&#39; to return type ... #3738</a></p><p>这个问题是由于<code>MapboxMaps</code>包里面有一个过时的属性，导致编译错误。我们通过修改这个属性，使其返回一个空字典，从而解决了编译错误。我们是通过<code>@rnmapbox/maps</code>来使用<code>Mapbox</code>的，<code>@rnmapbox/maps 10.1.33</code>对应版本对应的版本<code>^2.9.0</code>。目前最新的<a href="https://github.com/mapbox/mapbox-gl-js" target="_blank" rel="noopener noreferrer">mapbox-gl-js</a>版本为<code>v3.9.2</code>。所以很有可能是<code>@rnmapbox/maps</code>使用了太旧的<code>mapbox-gl</code>版本导致的，需要更新并兼容新版本才能从根本上解决问题。</p><p><strong>注意</strong> 上面的原因，只是猜测，如果要确认，则需要去<code>mapbox-gl</code>的源码中去看看。</p><h2 id="参考" tabindex="-1"><a class="header-anchor" href="#参考"><span>参考</span></a></h2><p><a href="https://github.com/rnmapbox/maps/issues/3738" target="_blank" rel="noopener noreferrer">not convert return expression of type &#39;[UIView : ViewAnnotationOptions]&#39; to return ... #3738</a></p><p><a href="https://rnmapbox.github.io" target="_blank" rel="noopener noreferrer">@rnmapbox/maps 文档</a></p><p><a href="https://www.mapbox.com" target="_blank" rel="noopener noreferrer">Mapbox</a></p><p><a href="https://docs.mapbox.com" target="_blank" rel="noopener noreferrer">Mapbox 文档</a></p><p><a href="https://docs.mapbox.com/ios/maps/api/11.9.0/documentation/mapboxmaps/viewannotationmanager" target="_blank" rel="noopener noreferrer">MapboxMaps viewannotationmanager</a></p><p><a href="https://www.npmjs.com/package/mapbox-gl" target="_blank" rel="noopener noreferrer">npmjs mapbox-gl</a></p><p><a href="https://github.com/mapbox/mapbox-gl-js" target="_blank" rel="noopener noreferrer">Github mapbox-gl-js</a></p><p><a href="https://github.com/mapbox/mapbox-gl-native" target="_blank" rel="noopener noreferrer">Github mapbox-gl-native</a></p>`,32)]))}const h=i(t,[["render",p],["__file","6czbow8c.html.vue"]]),r=JSON.parse('{"path":"/article/6czbow8c.html","title":"MapboxMaps的ViewAnnotationManager在Xcode中编译错误","lang":"zh-CN","frontmatter":{"title":"MapboxMaps的ViewAnnotationManager在Xcode中编译错误","createTime":"2025/01/13 14:22:01","permalink":"/article/6czbow8c.html","tags":["issue","MapboxMaps","rnmapbox/maps"],"watermark":true},"headers":[],"readingTime":{"minutes":2.54,"words":762},"git":{"updatedTime":1755670488000,"contributors":[{"name":"唐道勇","username":"唐道勇","email":"matias@tangdaoyongdeMacBook-Pro.local","commits":1,"avatar":"https://avatars.githubusercontent.com/唐道勇?v=4","url":"https://github.com/唐道勇"}]},"filePathRelative":"issue/mapboxmaps的ViewAnnotationManager在XCode中编译错误.md","categoryList":[{"id":"0aae4c","sort":10042,"name":"issue"}],"bulletin":false}');export{h as comp,r as data};
